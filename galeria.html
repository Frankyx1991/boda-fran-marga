<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fran & Marga ‚Äî Galer√≠a</title>

<!-- Firebase COMPAT v9.22.0 (no modular v10) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<style>
  :root { --gold:#a47c3c; --gold2:#c59745 }
  html,body{height:100%;margin:0}
  body{
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    background:url('assets/fondo.jpg') center 30%/cover no-repeat fixed;
    color:#fff;font-family:Georgia,serif;text-align:center;
    text-shadow:0 2px 8px rgba(0,0,0,.6);
  }
  h1{font-size:2.2rem;margin:0}
  .date{margin:.2rem 0 1rem;font-size:1.1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{padding:.7rem 1.2rem;border:0;border-radius:12px;background:var(--gold);
       color:#fff;cursor:pointer;transition:.2s;font-size:1rem}
  .btn:hover{background:var(--gold2)}
  /* overlay progreso */
  #uploader{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;
            justify-content:center;align-items:center;flex-direction:column;z-index:10}
  #bar{width:80%;height:10px;border-radius:8px;overflow:hidden;background:rgba(255,255,255,.3);margin:10px 0}
  #fill{height:100%;width:0;background:#f0d88a}
  #toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
         background:rgba(0,0,0,.75);padding:10px 16px;border-radius:10px;opacity:0;transition:.25s}
  #toast.show{opacity:1}
</style>
</head>
<body>
  <h1>Fran &amp; Marga</h1>
  <div class="date">11/10/2025</div>

  <div class="row">
    <button class="btn" id="btnPhoto">üì∑ Tomar foto</button>
    <button class="btn" id="btnVideo">üé• Grabar v√≠deo</button>
    <button class="btn" id="btnGallery">üñºÔ∏è Subir desde galer√≠a</button>
  </div>

  <!-- inputs ocultos -->
  <input id="inPhoto"   type="file" accept="image/*" capture="environment" hidden>
  <input id="inVideo"   type="file" accept="video/*" capture="camcorder" hidden>
  <input id="inGallery" type="file" accept="image/*,video/*" hidden>

  <!-- overlay progreso -->
  <div id="uploader">
    <div>Subiendo...</div>
    <div id="bar"><div id="fill"></div></div>
    <div id="pct">0%</div>
    <div>No cierres esta p√°gina</div>
  </div>
  <div id="toast"></div>

<script>
  // *** CONFIG FIREBASE (bucket appspot.com) ***
  const firebaseConfig = {
    apiKey: "AIzaSyCnkjY4-MceKRyLmQlMVaA39hUIQ6nMVO8",
    authDomain: "boda-fran-marga-live.firebaseapp.com",
    projectId: "boda-fran-marga-live",
    storageBucket: "boda-fran-marga-live.appspot.com", // <- IMPORTANTE
    messagingSenderId: "945235222189",
    appId: "1:945235222189:web:ed972fab8e98620d21b024"
  };
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();

  // utilidades UI
  const $ = s => document.querySelector(s);
  const toast = m => { const t=$("#toast"); t.textContent=m; t.classList.add("show");
    clearTimeout(window.__t); window.__t=setTimeout(()=>t.classList.remove("show"), 4000); };
  const showUp = on => { $("#uploader").style.display = on ? "flex" : "none"; };
  const setPct = p => { $("#fill").style.width = p+"%"; $("#pct").textContent = p+"%"; };

  // Deducir contentType cuando el navegador no lo env√≠a
  function guessType(name, type){
    if (type) return type;
    const n = (name||'').toLowerCase();
    if (n.endsWith('.jpg')||n.endsWith('.jpeg')) return 'image/jpeg';
    if (n.endsWith('.png'))  return 'image/png';
    if (n.endsWith('.webp')) return 'image/webp';
    if (n.endsWith('.gif'))  return 'image/gif';
    if (n.endsWith('.heic')) return 'image/heic';
    if (n.endsWith('.mp4'))  return 'video/mp4';
    if (n.endsWith('.mov'))  return 'video/quicktime';
    return 'application/octet-stream';
  }

  async function upload(file, folder){
    if(!file){ toast("No se seleccion√≥ archivo"); return; }
    const ts   = new Date().toISOString().replace(/[:.]/g,'-');
    const safe = (file.name||'archivo').replace(/\s+/g,'_');
    const path = `boda-fran-marga/${folder}/${ts}_${Math.floor(Math.random()*1e6)}_${safe}`;
    const ref  = storage.ref().child(path);
    const meta = { contentType: guessType(file.name, file.type) };

    showUp(true); setPct(0);

    try {
      const task = ref.put(file, meta);
      let progressed = false;

      const watchdog = setTimeout(()=>{ 
        if(!progressed) toast("Sin progreso‚Ä¶ revisa conexi√≥n o reglas"); 
      }, 8000);

      await new Promise((res,rej)=>{
        task.on('state_changed',
          s=>{ progressed = true; setPct(Math.round(100*s.bytesTransferred/s.totalBytes)); },
          e=>rej(e),
          ()=>res()
        );
      });
      clearTimeout(watchdog);
      setPct(100);
      toast("‚úÖ ¬°Gracias por compartir este momento con nosotros!");
    } catch(e){
      console.error(e);
      toast(`‚ùå Error al subir: ${e.code||''} ${e.message||e}`);
    } finally {
      setTimeout(()=>showUp(false), 600);
    }
  }

  // eventos
  $("#btnPhoto").onclick   = ()=> $("#inPhoto").click();
  $("#btnVideo").onclick   = ()=> $("#inVideo").click();
  $("#btnGallery").onclick = ()=> $("#inGallery").click();

  $("#inPhoto").onchange   = e => upload(e.target.files[0], 'fotos');
  $("#inVideo").onchange   = e => upload(e.target.files[0], 'videos');
  $("#inGallery").onchange = e => upload(e.target.files[0], 'galeria');

  // Captura errores JS para que no ‚Äúparezca‚Äù que no hace nada
  window.addEventListener('error', ev => toast('JS: '+ev.message));
</script>
</body>
</html>