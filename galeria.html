<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fran & Marga — 11/10/2025</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="stage">
    <header class="overlay">
      <h1>Fran &amp; Marga</h1>
      <p class="date">11/10/2025</p>
    </header>

    <div class="controls">
      <button id="btnPhoto"   class="btn-primary">📷 Tomar foto</button>
      <button id="btnVideo"   class="btn-primary">🎥 Grabar vídeo</button>
      <button id="btnGallery" class="btn-primary">🖼️ Subir desde galería</button>
    </div>

    <!-- Inputs ocultos -->
    <input id="inPhoto"   type="file" accept="image/*"        capture="environment" hidden>
    <input id="inVideo"   type="file" accept="video/*"        capture="camcorder"   hidden>
    <input id="inGallery" type="file" accept="image/*,video/*"                      hidden>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- PROGRESO -->
    <div id="uploader" class="uploader" aria-live="polite" aria-label="Progreso de subida" hidden>
      <div class="uploader-box">
        <p class="uploader-title">Subiendo…</p>
        <div class="bar">
          <div class="bar-fill" id="barFill" style="width:0%"></div>
        </div>
        <p class="uploader-percent"><span id="pct">0</span>%</p>
        <p class="uploader-tip">No cierres esta página</p>
      </div>
    </div>
  </main>

  <script>
    // URL de tu Web App (la que muestra "OK" al abrirla)
    const APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbxXP8C7m2wZs_PouM0eS482y63bPymYPTws-u1LdH6yF5vGhSR7E4uBAFkguWA93BPn/exec";

    // Helpers UI
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const toast = (msg) => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>el.classList.remove('show'), 3500);
    };

    const setControlsEnabled = (on) => {
      $$('.btn-primary').forEach(b => b.disabled = !on);
    };

    // Uploader overlay
    const showUploader = (on) => {
      const up = $('#uploader');
      up.hidden = !on;
      if (on) {
        $('#barFill').style.width = '0%';
        $('#pct').textContent = '0';
      }
    };
    const setProgress = (pct) => {
      $('#barFill').style.width = pct + '%';
      $('#pct').textContent = pct;
    };

    // Subida con progreso usando XHR
    async function uploadFile(file, folder){
      if (!file) return;
      setControlsEnabled(false);
      showUploader(true);
      toast('Preparando subida…');

      const form = new FormData();
      form.append('file', file);
      form.append('folder', folder); // 'fotos' | 'videos' | 'galeria'

      try {
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', APPS_SCRIPT_URL, true);

          // Progreso de subida
          xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
              const pct = Math.min(100, Math.round((e.loaded / e.total) * 100));
              setProgress(pct);
            } else {
              // Si no es computable, avanzamos suavemente hasta 90%
              const current = parseInt($('#pct').textContent || '0', 10);
              if (current < 90) setProgress(current + 1);
            }
          };

          // Éxito (aunque no podamos leer la respuesta por CORS)
          xhr.onload = () => resolve();
          xhr.onerror = () => reject(new Error('Fallo de red'));
          xhr.send(form);
        });

        setProgress(100);
        toast('¡Gracias por compartir este momento con nosotros 💖!');
      } catch (err) {
        console.error(err);
        toast('Error al subir. Vuelve a intentarlo.');
      } finally {
        setTimeout(() => { showUploader(false); setControlsEnabled(true); }, 600);
      }
    }

    // Enlaces botones → inputs
    const inPhoto   = $('#inPhoto');
    const inVideo   = $('#inVideo');
    const inGallery = $('#inGallery');

    $('#btnPhoto').onclick   = () => inPhoto.click();
    $('#btnVideo').onclick   = () => inVideo.click();
    $('#btnGallery').onclick = () => inGallery.click();

    inPhoto.onchange   = (e) => uploadFile(e.target.files[0], 'fotos');
    inVideo.onchange   = (e) => uploadFile(e.target.files[0], 'videos');
    inGallery.onchange = (e) => uploadFile(e.target.files[0], 'galeria');
  </script>
</body>
</html>