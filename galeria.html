<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fran & Marga — 11/10/2025</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="stage">
    <header class="overlay">
      <h1>Fran &amp; Marga</h1>
      <p class="date">11/10/2025</p>
    </header>

    <nav class="controls" aria-label="Acciones de subida">
      <button id="btnPhoto"   class="btn-primary">📷 Tomar foto</button>
      <button id="btnVideo"   class="btn-primary">🎥 Grabar vídeo</button>
      <button id="btnGallery" class="btn-primary">🖼️ Subir desde galería</button>
    </nav>

    <!-- Inputs ocultos -->
    <input id="inPhoto"   type="file" accept="image/*" capture="environment" hidden>
    <input id="inVideo"   type="file" accept="video/*" capture="camcorder"   hidden>
    <input id="inGallery" type="file" accept="image/*,video/*"               hidden>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- PROGRESO -->
    <div id="uploader" class="uploader" aria-live="polite" aria-label="Progreso de subida" hidden>
      <div class="uploader-box">
        <p class="uploader-title">Subiendo…</p>
        <div class="bar"><div class="bar-fill" id="barFill" style="width:0%"></div></div>
        <p class="uploader-percent"><span id="pct">0</span>%</p>
        <p class="uploader-tip">No cierres esta página</p>
      </div>
    </div>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <script>
    // ===== Config de tu proyecto (revisa el bucket: .appspot.com) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCnkjY4-MceKRyLmQlMVaA39hUIQ6nMVO8",
      authDomain: "boda-fran-marga-live.firebaseapp.com",
      projectId: "boda-fran-marga-live",
      storageBucket: "boda-fran-marga-live.appspot.com",
      messagingSenderId: "945235222189",
      appId: "1:945235222189:web:ed972fab8e98620d21b024"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // ===== UI helpers =====
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show');
      clearTimeout(window.__t); window.__t=setTimeout(()=>t.classList.remove('show'), 4000); };
    const setControlsEnabled = on => $$('.btn-primary').forEach(b=>b.disabled=!on);
    const showUploader = on => { const u=$('#uploader'); u.hidden=!on;
      if(on){ $('#barFill').style.width='0%'; $('#pct').textContent='0'; } };
    const setProgress = p => { $('#barFill').style.width=p+'%'; $('#pct').textContent=p; };

    // ===== Deducción de MIME si el móvil no lo aporta =====
    function guessContentType(file){
      if (file.type) return file.type;
      const n = (file.name||'').toLowerCase();
      if (n.endsWith('.jpg')||n.endsWith('.jpeg')) return 'image/jpeg';
      if (n.endsWith('.png'))  return 'image/png';
      if (n.endsWith('.heic')) return 'image/heic';
      if (n.endsWith('.webp')) return 'image/webp';
      if (n.endsWith('.gif'))  return 'image/gif';
      if (n.endsWith('.mp4'))  return 'video/mp4';
      if (n.endsWith('.mov'))  return 'video/quicktime';
      return 'application/octet-stream';
    }

    // ===== Test diagnóstico si no avanza del 0% =====
    async function testDiagnostico(){
      try{
        const dataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==";
        const res = await fetch(dataUrl);
        const blob = await res.blob();
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const ref = storage.ref().child(`boda-fran-marga/diagnostico/${ts}_ping.png`);
        await ref.put(blob, {contentType:'image/png'});
        toast('Diagnóstico OK: conexión y reglas correctas ✅');
        return true;
      }catch(e){
        console.error('Diagnóstico fallo:', e);
        toast('Diagnóstico falló: ' + (e.code || e.message));
        return false;
      }
    }

    // ===== Subida con progreso (rutas: /boda-fran-marga/**) =====
    async function uploadToFirebase(file, folder){
      if(!file){ toast('Selecciona un archivo.'); return; }

      const ts   = new Date().toISOString().replace(/[:.]/g,'-');
      const safe = (file.name || 'archivo').replace(/\s+/g,'_');
      const path = `boda-fran-marga/${folder}/${ts}_${Math.floor(Math.random()*1e6)}_${safe}`;
      const ref  = storage.ref().child(path);
      const meta = { contentType: guessContentType(file) };

      let watchdog;
      try{
        setControlsEnabled(false); showUploader(true); toast('Subiendo…');

        const task = ref.put(file, meta);

        // Si en 8s no se mueve del 0%, lanza diagnóstico
        watchdog = setTimeout(async ()=>{
          const pctText = document.getElementById('pct').textContent;
          if (pctText === '0') {
            toast('Sin progreso… probando diagnóstico ⚙️');
            await testDiagnostico();
          }
        }, 8000);

        await new Promise((resolve, reject)=>{
          task.on('state_changed',
            snap => { const pct = Math.round((snap.bytesTransferred/snap.totalBytes)*100); setProgress(pct); },
            err  => reject(err),
            ()   => resolve()
          );
        });

        setProgress(100);
        toast('✅ ¡Gracias por compartir este momento con nosotros!');
      }catch(err){
        console.error('Upload error:', err);
        let msg = '❌ Error al subir';
        if (err && err.code) msg += ` (${err.code})`;
        if (err && err.message) msg += ` — ${err.message}`;
        toast(msg);
      }finally{
        clearTimeout(watchdog);
        showUploader(false);
        setControlsEnabled(true);
      }
    }

    // ===== Enlaza botones → inputs =====
    const inPhoto   = document.getElementById('inPhoto');
    const inVideo   = document.getElementById('inVideo');
    const inGallery = document.getElementById('inGallery');

    document.getElementById('btnPhoto')  .onclick = ()=> inPhoto.click();
    document.getElementById('btnVideo')  .onclick = ()=> inVideo.click();
    document.getElementById('btnGallery').onclick = ()=> inGallery.click();

    inPhoto.onchange   = e => uploadToFirebase(e.target.files[0], 'fotos');
    inVideo.onchange   = e => uploadToFirebase(e.target.files[0], 'videos');
    inGallery.onchange = e => uploadToFirebase(e.target.files[0], 'galeria');
  </script>
</body>
</html>